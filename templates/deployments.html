{% extends "base.html" %}

{% block title %}Deployments - DockWINterface{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-server me-2"></i>Container Deployments</h2>
            <div>
                <button class="btn btn-outline-light me-2" onclick="refreshDeployments()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <a href="{{ url_for('wizard') }}" class="btn btn-danger">
                    <i class="fas fa-plus me-1"></i>New Deployment
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Deployment Statistics -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="stats-card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3 class="stats-number text-success" id="runningContainers">0</h3>
                        <p class="stats-label">Running</p>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-play-circle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="stats-card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3 class="stats-number text-warning" id="stoppedContainers">0</h3>
                        <p class="stats-label">Stopped</p>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-stop-circle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="stats-card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3 class="stats-number text-danger" id="errorContainers">0</h3>
                        <p class="stats-label">Error</p>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="stats-card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3 class="stats-number" id="totalContainers">0</h3>
                        <p class="stats-label">Total</p>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-layer-group"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <!-- Deployments Table -->
        <div class="card bg-dark-custom border-secondary">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Container List</h5>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" class="form-control bg-dark text-light" placeholder="Search containers..." id="searchInput">
                        <span class="input-group-text bg-secondary border-secondary">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="deploymentsTable">
                    <!-- Deployments will be loaded here -->
                    <div class="text-center py-5">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <h4>No deployments found</h4>
                        <p class="text-muted mb-3">Start by creating your first Windows container configuration</p>
                        <a href="{{ url_for('wizard') }}" class="btn btn-danger">
                            <i class="fas fa-magic me-1"></i>Create Configuration
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Container Details Modal -->
<div class="modal fade" id="containerDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark-custom">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>Container Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="containerDetailsContent">
                    <!-- Container details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="actionButton">Action</button>
            </div>
        </div>
    </div>
</div>

<!-- Container Logs Modal -->
<div class="modal fade" id="containerLogsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark-custom">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>Container Logs
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefreshLogs">
                        <label class="form-check-label" for="autoRefreshLogs">
                            Auto-refresh logs
                        </label>
                    </div>
                    <button class="btn btn-outline-light btn-sm" onclick="refreshLogs()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
                <pre class="bg-dark text-light p-3 rounded" style="max-height: 500px; overflow-y: auto;" id="containerLogsContent">
Loading logs...
                </pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-light" onclick="downloadLogs()">
                    <i class="fas fa-download me-1"></i>Download Logs
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark-custom">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this container?</p>
                <p class="text-warning"><strong>Warning:</strong> This action cannot be undone. All data in the container will be lost unless you have persistent volumes configured.</p>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="forceDelete">
                    <label class="form-check-label" for="forceDelete">
                        Force delete (removes container even if running)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-1"></i>Delete Container
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Sample Deployment Data (for demonstration) -->
<script>
    // Sample deployments data
    const sampleDeployments = [
        {
            id: 'windows-11-dev',
            name: 'windows-11-dev',
            status: 'running',
            image: 'dockurr/windows:11',
            created: '2024-01-15T10:30:00Z',
            ports: ['3389:3389', '8006:8006'],
            cpu: '4 cores',
            memory: '8GB',
            storage: '40GB',
            uptime: '2 days'
        },
        {
            id: 'windows-server-2022',
            name: 'windows-server-2022',
            status: 'stopped',
            image: 'dockurr/windows:2022',
            created: '2024-01-10T14:20:00Z',
            ports: ['3390:3389', '8007:8006'],
            cpu: '6 cores',
            memory: '12GB',
            storage: '80GB',
            uptime: '0 minutes'
        },
        {
            id: 'windows-10-test',
            name: 'windows-10-test',
            status: 'error',
            image: 'dockurr/windows:10',
            created: '2024-01-12T09:15:00Z',
            ports: ['3391:3389', '8008:8006'],
            cpu: '2 cores',
            memory: '4GB',
            storage: '30GB',
            uptime: '0 minutes'
        }
    ];
</script>
{% endblock %}

{% block scripts %}
<script>
    let currentContainerId = null;
    let logRefreshInterval = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadDeployments();
        updateDeploymentStats();
        
        // Setup search functionality
        document.getElementById('searchInput').addEventListener('input', filterDeployments);
    });

    function loadDeployments() {
        const tableContainer = document.getElementById('deploymentsTable');
        
        if (sampleDeployments.length === 0) {
            tableContainer.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                    <h4>No deployments found</h4>
                    <p class="text-muted mb-3">Start by creating your first Windows container configuration</p>
                    <a href="${window.location.origin}/wizard" class="btn btn-danger">
                        <i class="fas fa-magic me-1"></i>Create Configuration
                    </a>
                </div>
            `;
            return;
        }

        const tableHTML = `
            <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Image</th>
                            <th>Resources</th>
                            <th>Ports</th>
                            <th>Uptime</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sampleDeployments.map(deployment => `
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fab fa-windows me-2 text-info"></i>
                                        <span>${deployment.name}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge ${getStatusBadgeClass(deployment.status)}">
                                        <i class="fas ${getStatusIcon(deployment.status)} me-1"></i>
                                        ${deployment.status.charAt(0).toUpperCase() + deployment.status.slice(1)}
                                    </span>
                                </td>
                                <td>
                                    <small class="text-muted">${deployment.image}</small>
                                </td>
                                <td>
                                    <small>
                                        <div><i class="fas fa-microchip me-1"></i>${deployment.cpu}</div>
                                        <div><i class="fas fa-memory me-1"></i>${deployment.memory}</div>
                                        <div><i class="fas fa-hdd me-1"></i>${deployment.storage}</div>
                                    </small>
                                </td>
                                <td>
                                    <small class="text-muted">${deployment.ports.join(', ')}</small>
                                </td>
                                <td>
                                    <small>${deployment.uptime}</small>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-light" onclick="viewContainerDetails('${deployment.id}')" title="Details">
                                            <i class="fas fa-info"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-light" onclick="viewContainerLogs('${deployment.id}')" title="Logs">
                                            <i class="fas fa-file-alt"></i>
                                        </button>
                                        ${deployment.status === 'running' ? 
                                            `<button class="btn btn-sm btn-outline-warning" onclick="stopContainer('${deployment.id}')" title="Stop">
                                                <i class="fas fa-stop"></i>
                                            </button>` :
                                            `<button class="btn btn-sm btn-outline-success" onclick="startContainer('${deployment.id}')" title="Start">
                                                <i class="fas fa-play"></i>
                                            </button>`
                                        }
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteContainer('${deployment.id}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        tableContainer.innerHTML = tableHTML;
    }

    function getStatusBadgeClass(status) {
        switch(status) {
            case 'running': return 'bg-success';
            case 'stopped': return 'bg-warning';
            case 'error': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    function getStatusIcon(status) {
        switch(status) {
            case 'running': return 'fa-play-circle';
            case 'stopped': return 'fa-stop-circle';
            case 'error': return 'fa-exclamation-triangle';
            default: return 'fa-question-circle';
        }
    }

    function updateDeploymentStats() {
        const running = sampleDeployments.filter(d => d.status === 'running').length;
        const stopped = sampleDeployments.filter(d => d.status === 'stopped').length;
        const error = sampleDeployments.filter(d => d.status === 'error').length;
        const total = sampleDeployments.length;

        document.getElementById('runningContainers').textContent = running;
        document.getElementById('stoppedContainers').textContent = stopped;
        document.getElementById('errorContainers').textContent = error;
        document.getElementById('totalContainers').textContent = total;
    }

    function filterDeployments() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const table = document.querySelector('#deploymentsTable table tbody');
        const rows = table.querySelectorAll('tr');

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    }

    function refreshDeployments() {
        // Simulate refresh
        showNotification('Deployments refreshed', 'success');
        loadDeployments();
        updateDeploymentStats();
    }

    function viewContainerDetails(containerId) {
        const deployment = sampleDeployments.find(d => d.id === containerId);
        if (!deployment) return;

        const detailsContent = document.getElementById('containerDetailsContent');
        detailsContent.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Basic Information</h6>
                    <table class="table table-dark table-sm">
                        <tr><td>Name:</td><td>${deployment.name}</td></tr>
                        <tr><td>Status:</td><td><span class="badge ${getStatusBadgeClass(deployment.status)}">${deployment.status}</span></td></tr>
                        <tr><td>Image:</td><td>${deployment.image}</td></tr>
                        <tr><td>Created:</td><td>${new Date(deployment.created).toLocaleString()}</td></tr>
                        <tr><td>Uptime:</td><td>${deployment.uptime}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Resource Allocation</h6>
                    <table class="table table-dark table-sm">
                        <tr><td>CPU:</td><td>${deployment.cpu}</td></tr>
                        <tr><td>Memory:</td><td>${deployment.memory}</td></tr>
                        <tr><td>Storage:</td><td>${deployment.storage}</td></tr>
                        <tr><td>Ports:</td><td>${deployment.ports.join(', ')}</td></tr>
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <h6>Quick Actions</h6>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light btn-sm" onclick="connectRDP('${deployment.id}')">
                            <i class="fas fa-desktop me-1"></i>Connect RDP
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="connectVNC('${deployment.id}')">
                            <i class="fas fa-tv me-1"></i>Open VNC
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="downloadConfig('${deployment.id}')">
                            <i class="fas fa-download me-1"></i>Download Config
                        </button>
                    </div>
                </div>
            </div>
        `;

        new bootstrap.Modal(document.getElementById('containerDetailsModal')).show();
    }

    function viewContainerLogs(containerId) {
        currentContainerId = containerId;
        document.getElementById('containerLogsContent').textContent = 'Loading logs...';
        
        // Simulate loading logs
        setTimeout(() => {
            const logs = `
[2024-01-15 10:30:15] Starting Windows container...
[2024-01-15 10:30:16] Initializing virtual machine
[2024-01-15 10:30:20] Windows boot process started
[2024-01-15 10:31:45] Windows desktop ready
[2024-01-15 10:31:50] RDP server started on port 3389
[2024-01-15 10:31:51] VNC server started on port 8006
[2024-01-15 10:31:52] Container ready for connections
[2024-01-15 12:15:30] User connected via RDP
[2024-01-15 14:22:10] System health check: OK
[2024-01-15 16:45:22] Automatic backup completed
            `;
            document.getElementById('containerLogsContent').textContent = logs;
        }, 1000);

        new bootstrap.Modal(document.getElementById('containerLogsModal')).show();
    }

    function startContainer(containerId) {
        showNotification(`Starting container ${containerId}...`, 'info');
        // Simulate container start
        setTimeout(() => {
            showNotification(`Container ${containerId} started successfully`, 'success');
            refreshDeployments();
        }, 2000);
    }

    function stopContainer(containerId) {
        showNotification(`Stopping container ${containerId}...`, 'info');
        // Simulate container stop
        setTimeout(() => {
            showNotification(`Container ${containerId} stopped successfully`, 'success');
            refreshDeployments();
        }, 2000);
    }

    function deleteContainer(containerId) {
        currentContainerId = containerId;
        new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
        
        document.getElementById('confirmDeleteBtn').onclick = function() {
            const force = document.getElementById('forceDelete').checked;
            showNotification(`Deleting container ${containerId}...`, 'info');
            
            // Simulate container deletion
            setTimeout(() => {
                showNotification(`Container ${containerId} deleted successfully`, 'success');
                // Remove from sample data
                const index = sampleDeployments.findIndex(d => d.id === containerId);
                if (index > -1) {
                    sampleDeployments.splice(index, 1);
                }
                refreshDeployments();
                bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
            }, 2000);
        };
    }

    function connectRDP(containerId) {
        const deployment = sampleDeployments.find(d => d.id === containerId);
        if (deployment) {
            const rdpPort = deployment.ports.find(p => p.includes('3389')).split(':')[0];
            showNotification(`RDP connection available at localhost:${rdpPort}`, 'info');
        }
    }

    function connectVNC(containerId) {
        const deployment = sampleDeployments.find(d => d.id === containerId);
        if (deployment) {
            const vncPort = deployment.ports.find(p => p.includes('8006')).split(':')[0];
            window.open(`http://localhost:${vncPort}`, '_blank');
        }
    }

    function downloadConfig(containerId) {
        showNotification(`Downloading configuration for ${containerId}...`, 'info');
        // Simulate config download
        setTimeout(() => {
            showNotification('Configuration files downloaded', 'success');
        }, 1000);
    }

    function refreshLogs() {
        if (currentContainerId) {
            viewContainerLogs(currentContainerId);
        }
    }

    function downloadLogs() {
        const logs = document.getElementById('containerLogsContent').textContent;
        const blob = new Blob([logs], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentContainerId}-logs.txt`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // Auto-refresh logs functionality
    document.getElementById('autoRefreshLogs').addEventListener('change', function() {
        if (this.checked) {
            logRefreshInterval = setInterval(refreshLogs, 5000);
        } else {
            clearInterval(logRefreshInterval);
        }
    });
</script>
{% endblock %}
